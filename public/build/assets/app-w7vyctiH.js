import{r as l,j as e,c as j,R as v,a as b}from"./vendor-react-KHOBbFxj.js";import{b as N,d as E,u as I,r as F,e as M}from"./auth-modules-Tx9inXK_.js";import"./analytics-Ck74oY65.js";import"./vendor-DZtHqBjz.js";import"./vendor-axios-xsH4HHeE.js";import"./ui-components-uVfRm-cR.js";const k=()=>{const[t,o]=l.useState({items:[],total:0,subtotal:0,discount:0,shipping:0,tax:0,loading:!0,error:null}),s=l.useCallback(async()=>{o(a=>({...a,loading:!0}));try{const a=await N();if(console.log("API Response for fetchCartContents (full data):",JSON.stringify(a.data,null,2)),a.success&&a.data){const{items:c}=a.data,{totalPrice:n,subtotal:r,discount:d,shipping:m,tax:p}=a.data.summary;console.log("Received cart data from API (extracted values):",{items:c,total:n,subtotal:r,discount:d,shipping:m,tax:p}),o({items:c||[],total:n||0,subtotal:r||0,discount:d||0,shipping:m||0,tax:p||0,loading:!1,error:null})}else console.error("Failed to fetch cart contents:",a.message||"No data received."),o(c=>({...c,loading:!1,error:a.message||"Failed to fetch cart contents."}))}catch(a){console.error("Error loading cart:",a),o(c=>({...c,loading:!1,error:a.message||"Error loading cart."}))}},[]);l.useEffect(()=>{s()},[s]);const u=l.useCallback(async(a,c)=>{o(n=>({...n,loading:!0}));try{const n=await E(a,c);n.success?(window.showMessage(n.message||"محصول با موفقیت به سبد خرید اضافه شد.","success"),await s()):(window.showMessage(n.message||"خطا در افزودن محصول.","error"),o(r=>({...r,loading:!1,error:n.message||"Failed to add item."})))}catch(n){console.error("Failed to add item:",n),window.showMessage("خطا در افزودن محصول به سبد خرید.","error"),o(r=>({...r,loading:!1,error:"Failed to add item."}))}},[s]),i=l.useCallback(async(a,c)=>{o(n=>({...n,loading:!0}));try{const n=await I(a,c);n.success?(window.showMessage(n.message||"تعداد محصول به‌روزرسانی شد.","success"),await s()):(window.showMessage(n.message||"خطا در به‌روزرسانی تعداد محصول.","error"),o(r=>({...r,loading:!1,error:n.message||"Failed to update quantity."})))}catch(n){console.error("Failed to update quantity:",n),window.showMessage("خطا در به‌روزرسانی تعداد محصول.","error"),o(r=>({...r,loading:!1,error:"Failed to update quantity."}))}},[s]),f=l.useCallback(async a=>{o(c=>({...c,loading:!0}));try{const c=await F(a);c.success?(window.showMessage(c.message||"محصول از سبد خرید حذف شد.","success"),await s()):(window.showMessage(c.message||"خطا در حذف محصول.","error"),o(n=>({...n,loading:!1,error:c.message||"Failed to remove item."})))}catch(c){console.error("Failed to remove item:",c),window.showMessage("خطا در حذف محصول از سبد خرید.","error"),o(n=>({...n,loading:!1,error:"Failed to remove item."}))}},[s]),g=l.useCallback(async()=>{o(a=>({...a,loading:!0}));try{await M(),window.showMessage("سبد خرید شما خالی شد.","success"),await s()}catch(a){console.error("Failed to clear cart:",a),window.showMessage("خطا در پاک کردن سبد خرید.","error"),o(c=>({...c,loading:!1,error:"Failed to clear cart."}))}},[s]);return{cartItems:t.items,cartTotal:t.total,cartSubtotal:t.subtotal,cartDiscount:t.discount,cartShipping:t.shipping,cartTax:t.tax,cartLoading:t.loading,cartError:t.error,addItem:u,updateQuantity:i,removeFromCart:f,clearAllItems:g,loadCart:s}},y=l.createContext(void 0),C=()=>{const t=l.useContext(y);if(!t)throw new Error("useCartContext must be used within a CartProvider");return t},L=({children:t})=>{const o=k();return e.jsx(y.Provider,{value:o,children:t})},P=({item:t,onRemove:o,onUpdateQuantity:s})=>{var c,n;console.log("CartItem received item (full content):",JSON.stringify(t,null,2));const{cartLoading:u}=C(),i=((c=t.product)==null?void 0:c.name)||"نامشخص",f=(n=t.product)==null?void 0:n.image,g=t.formattedUnitPrice||"قیمت نامعتبر";console.log(`CartItem - Product Name: "${i}"`),console.log(`CartItem - Formatted Price: "${g}"`),console.log(`CartItem - Product Image: "${f}"`);const a=r=>{const d=parseInt(r.target.value,10);!isNaN(d)&&d>0&&s(t.id,d)};return e.jsxs("div",{className:"flex items-center p-3 border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"flex-shrink-0 w-16 h-16 rounded-md overflow-hidden mr-3",children:e.jsx("img",{src:f||`https://placehold.co/64x64/E2E8F0/64748B?text=${encodeURIComponent(i)}`,alt:i,className:"w-full h-full object-cover",onError:r=>{r.currentTarget.src=`https://placehold.co/64x64/E2E8F0/64748B?text=${encodeURIComponent(i)}`}})}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 line-clamp-2",children:i}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:g})]}),e.jsxs("div",{className:"flex items-center ml-3",children:[e.jsx("select",{value:t.quantity,onChange:a,disabled:u,className:"form-select text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 w-16 text-center","aria-label":`تعداد ${i}`,children:[...Array(10).keys()].map(r=>e.jsx("option",{value:r+1,children:r+1},r+1))}),e.jsx("button",{onClick:()=>o(t.id),disabled:u,className:"ml-2 text-red-500 hover:text-red-700 transition-colors p-1 rounded-full hover:bg-red-50","aria-label":`حذف ${i}`,children:e.jsx("i",{className:"fas fa-trash-alt text-sm"})})]})]})},R=({total:t,loading:o=!1})=>{console.log("CartFooter received total:",t);const s=t===0||o,u=i=>{if(s){i.preventDefault();return}console.log("Checkout initiated with total:",t)};return e.jsxs("div",{className:"p-4 border-t border-gray-200",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("span",{className:"text-md font-semibold text-gray-700",children:"مجموع کل:"}),e.jsxs("span",{className:"text-lg font-bold text-green-700",children:[t.toLocaleString()," تومان"]})]}),e.jsxs("div",{className:"flex flex-col space-y-3",children:[e.jsx("a",{href:"/cart",className:`w-full text-center ${s?"btn-disabled pointer-events-none":"btn-secondary"}`,"aria-disabled":s,tabIndex:s?-1:0,children:"مشاهده سبد خرید"}),e.jsx("a",{href:"/checkout",onClick:u,className:`w-full text-center ${s?"btn-disabled pointer-events-none":"btn-primary"}`,"aria-disabled":s,tabIndex:s?-1:0,children:"ادامه جهت تکمیل سفارش"})]})]})},T=({isOpen:t,onClose:o})=>{const{cartItems:s,cartTotal:u,removeFromCart:i,updateQuantity:f,cartLoading:g}=C();return t?e.jsxs("div",{className:"absolute top-full right-1/2 mt-1 w-72 md:w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-[9999] overflow-hidden",style:{transform:"translate(82.4%, -1.2vh)"},children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"سبد خرید"}),e.jsx("button",{onClick:o,className:"text-gray-500 hover:text-gray-700 transition-colors","aria-label":"بستن سبد خرید",children:e.jsx("i",{className:"fas fa-times"})})]}),g?e.jsx("p",{className:"text-center text-gray-500 py-8",children:"در حال بارگذاری سبد خرید..."}):e.jsx("div",{className:"max-h-60 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100",children:s.length===0?e.jsx("p",{className:"text-center text-gray-500 py-8",children:"سبد خرید شما خالی است."}):s.map(a=>e.jsx(P,{item:a,onRemove:i,onUpdateQuantity:f},a.id))}),s.length>0&&e.jsx(R,{total:u,loading:g})]}):null},$=({productId:t,productName:o,price:s})=>{const{addItem:u}=C(),[i,f]=l.useState(!1),g=async()=>{f(!0);try{await u(t,1)}catch(a){console.error("Failed to add item via button:",a)}finally{f(!1)}};return e.jsx("button",{onClick:g,disabled:i,className:`btn-primary ${i?"btn-disabled":""} flex items-center`,children:i?"در حال افزودن...":e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-cart-plus ml-2"}),"افزودن به سبد"]})})},A=()=>{const[t,o]=l.useState(!1),{loadCart:s}=C(),u=l.useRef(null),i=l.useRef(null);l.useEffect(()=>{typeof window<"u"&&(window.loadCart=s,console.log("window.loadCart exposed for debugging."))},[s]);const f=l.useCallback(()=>{o(r=>!r)},[]),g=l.useCallback(()=>{o(!1)},[]),a=l.useCallback(r=>{u.current&&!u.current.contains(r.target)&&i.current&&!i.current.contains(r.target)&&g()},[g]),[c,n]=l.useState([]);return l.useEffect(()=>{const r=document.querySelectorAll('[id^="add-to-cart-root-"]'),d=[];r.forEach(m=>{const p=m.id.replace("add-to-cart-root-",""),x=m.dataset.productName,h=parseFloat(m.dataset.productPrice||"0");if(p&&x&&!isNaN(h)&&h>0)d.push(b.createPortal(e.jsx(v.StrictMode,{children:e.jsx($,{productId:p,productName:x,price:h})}),m)),console.log(`AddToCartButton portal created for product ${p}`);else{let w=`Could not create AddToCartButton portal for root: ${m.id}. Missing/invalid data: `;p||(w+="productId; "),x||(w+="productName; "),(isNaN(h)||h<=0)&&(w+=`price (${m.dataset.productPrice}); `),console.warn(w)}}),n(d)},[]),l.useEffect(()=>{const r=document.getElementById("mini-cart-toggle"),d=document.getElementById("mini-cart-root");u.current=r,i.current=d;let m=null;const p=()=>{m&&(clearTimeout(m),m=null),o(!0)},x=h=>{m=setTimeout(()=>{u.current&&!u.current.contains(document.elementFromPoint(h.clientX,h.clientY))&&i.current&&!i.current.contains(document.elementFromPoint(h.clientX,h.clientY))&&g()},100)};return r&&(r.addEventListener("click",f),r.addEventListener("mouseenter",p),r.addEventListener("mouseleave",x)),d&&(d.addEventListener("mouseenter",p),d.addEventListener("mouseleave",x)),document.addEventListener("mousedown",a),()=>{r&&(r.removeEventListener("click",f),r.removeEventListener("mouseenter",p),r.removeEventListener("mouseleave",x)),d&&(d.removeEventListener("mouseenter",p),d.removeEventListener("mouseleave",x)),document.removeEventListener("mousedown",a),m&&clearTimeout(m)}},[f,g,a]),e.jsxs(e.Fragment,{children:[typeof document<"u"&&document.getElementById("mini-cart-root")&&b.createPortal(e.jsx(T,{isOpen:t,onClose:g}),document.getElementById("mini-cart-root")),c]})},S=()=>{const t=document.getElementById("react-root");t?(j.createRoot(t).render(e.jsx(v.StrictMode,{children:e.jsx(L,{children:e.jsx(A,{})})})),console.log("Main React application mounted successfully with CartProvider.")):console.warn("Could not find #react-root element to mount the main React application. Ensure it exists in app.blade.php.")};window.addEventListener("DOMContentLoaded",S);
//# sourceMappingURL=app-w7vyctiH.js.map
