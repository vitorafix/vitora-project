const v={phone_number:/^09[0-9]{9}$/,postal_code:/^[0-9]{10}$/,first_name:/^[\u0600-\u06FF\s]{2,50}$/,last_name:/^[\u0600-\u06FF\s]{2,50}$/,address:/^.{10,200}$/},y={first_name:{required:"لطفاً نام کوچک خود را وارد کنید.",pattern:"نام کوچک باید شامل حروف فارسی باشد و حداقل ۲ کاراکتر باشد."},last_name:{required:"لطفاً نام خانوادگی خود را وارد کنید.",pattern:"نام خانوادگی باید شامل حروف فارسی باشد و حداقل ۲ کاراکتر باشد."},phone_number:{required:"لطفاً شماره تلفن خود را وارد کنید.",pattern:"فرمت شماره تلفن صحیح نیست. مثال: 09123456789"},address:{required:"لطفاً آدرس کامل خود را وارد کنید.",pattern:"آدرس باید حداقل ۱۰ کاراکتر باشد."},province:{required:"لطفاً استان خود را وارد کنید."},city:{required:"لطفاً شهر خود را وارد کنید."},postal_code:{required:"لطفاً کد پستی خود را وارد کنید.",pattern:"کد پستی باید ۱۰ رقمی باشد."},shipping_method:{required:"لطفاً روش ارسال را انتخاب کنید."},payment_method:{required:"لطفاً روش پرداخت را انتخاب کنید."},terms_agree:{required:"برای ثبت سفارش، باید قوانین و مقررات را بپذیرید."}},D=(e,r)=>{let t;return function(...i){const c=()=>{clearTimeout(t),e(...i)};clearTimeout(t),t=setTimeout(c,r)}};function b(e,r){const t=e.id+"-error",o=document.getElementById(t);o&&(o.textContent=r,o.classList.remove("hidden")),e.classList.add("border-red-500"),e.classList.remove("focus:ring-green-700","focus:border-green-700");const i=document.getElementById("form-errors-live-region");i&&(i.textContent=r)}function C(e){const r=e.id+"-error",t=document.getElementById(r);t&&(t.textContent="",t.classList.add("hidden")),e.classList.remove("border-red-500"),e.classList.add("focus:ring-green-700","focus:border-green-700");const o=document.getElementById("form-errors-live-region");o&&o.textContent===e.getAttribute("aria-describedby")&&(o.textContent="")}function k(e,r,t,o){return t&&!t.test(r)?(b(o,y[e].pattern),!1):(C(o),!0)}function q(e,r){const t=document.getElementById("progress-bar");if(t){const o=e/r*100;t.style.width=`${o}%`}}function x(e){var _;document.querySelectorAll(".text-red-500.text-sm.mt-1").forEach(n=>{n.textContent="",n.classList.add("hidden")}),document.querySelectorAll(".form-input, .form-radio, .form-checkbox").forEach(n=>{n.classList.remove("border-red-500"),n.classList.add("focus:ring-green-700","focus:border-green-700")});let r=!0,t=null;const o=(_=document.querySelector('input[name="selected_address_id"]:checked'))==null?void 0:_.value,i=[{id:"first_name",rule:v.first_name},{id:"last_name",rule:v.last_name},{id:"phone_number",rule:v.phone_number},{id:"address",rule:v.address},{id:"province",rule:null},{id:"city",rule:null},{id:"postal_code",rule:v.postal_code}];if(o==="new"||document.querySelectorAll('input[name="selected_address_id"]').length===0)for(const n of i){const a=document.getElementById(n.id);!a||!a.value.trim()?(b(a,y[n.id].required),r=!1,t||(t=a)):n.rule&&!k(n.id,a.value.trim(),n.rule,a)&&(r=!1,t||(t=a))}else if(!o){window.showMessage("لطفاً یک آدرس را انتخاب کنید یا آدرس جدیدی وارد کنید.","error"),r=!1;const n=document.querySelectorAll('input[name="selected_address_id"]');n.length>0&&n[0].focus()}if(!document.querySelector('input[name="shipping_method"]:checked')){const n=document.getElementById("shipping_post");n?(b(n,y.shipping_method.required),r=!1,t||(t=n)):(window.showMessage(y.shipping_method.required,"error"),r=!1)}if(!document.querySelector('input[name="payment_method"]:checked')){const n=document.getElementById("payment_online");n?(b(n,y.payment_method.required),r=!1,t||(t=n)):(window.showMessage(y.payment_method.required,"error"),r=!1)}const l=document.getElementById("terms_agree");l&&!l.checked?(b(l,y.terms_agree.required),r=!1,t||(t=l)):l||(console.error("Terms and conditions checkbox (terms_agree) not found."),window.showMessage(y.terms_agree.required,"error"),r=!1),!r&&t&&t.focus();const m=document.getElementById("form-errors-live-region");return m&&(r?m.textContent="":m.textContent="لطفاً تمام فیلدهای الزامی را به درستی پر کنید."),r}function $(e){let r="لطفاً اطلاعات ورودی را بررسی کنید: <br>";for(const t in e){r+=`- ${e[t].join(", ")}<br>`;const o=document.getElementById(t);o&&b(o,e[t].join(", "))}window.showMessage(r,"error",5e3),console.error("Order placement error (server validation failed):",{errors:e})}function R(e,r){window.showMessage(e.message||"خطا در ثبت سفارش. لطفاً دوباره تلاش کنید.","error"),console.error("Order placement error (client error):",{status:r,responseBody:e})}function j(e,r,t,o){console.warn(`Attempt ${t} failed. Retrying...`,{status:r,responseBody:e}),t<o?window.showMessage("خطا در ثبت سفارش. تلاش مجدد...","info",2e3):(window.showMessage(e.message||"خطا در ثبت سفارش. لطفاً دوباره تلاش کنید.","error"),console.error("Order placement error (all retries failed):",{status:r,responseBody:e}))}async function N(e,r=3,t=1e3){for(let o=0;o<r;o++){const i=new AbortController,c=setTimeout(()=>i.abort(),1e4);try{q(o+1,r+1);const d=await fetch("/order/place",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":A()},body:JSON.stringify(e),signal:i.signal});clearTimeout(c);const l=await d.json();if(d.ok)return q(r+1,r+1),l;if(d.status===422)throw $(l.errors),new Error("Validation failed on server");if(d.status>=400&&d.status<500)throw R(l,d.status),new Error("Client error, not retrying");if(j(l,d.status,o+1,r),o<r-1)await new Promise(m=>setTimeout(m,t*(o+1)));else throw new Error("All retries failed")}catch(d){if(clearTimeout(c),d.name==="AbortError")throw window.showMessage("درخواست بیش از حد طولانی شد. لطفاً دوباره تلاش کنید.","error"),console.error("Request timed out:",d),d;if(console.error(`Attempt ${o+1} caught an error:`,{message:d.message,stack:d.stack}),o<r-1)window.showMessage("خطا در ارتباط با سرور. تلاش مجدد...","info",2e3),await new Promise(l=>setTimeout(l,t*(o+1)));else throw window.showMessage("خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.","error"),d}}throw new Error("Unexpected error in placeOrderWithRetry")}function A(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}function P(){const e=document.getElementById("place-order-form");if(!e)return;const r=new FormData(e),t=Object.fromEntries(r.entries());try{localStorage.setItem("orderDraft",JSON.stringify(t))}catch(o){console.error("Error saving draft to local storage:",o)}}function J(){const e=document.getElementById("place-order-form");if(e)try{const r=localStorage.getItem("orderDraft");if(r){const t=JSON.parse(r);Object.entries(t).forEach(([o,i])=>{const c=e.querySelector(`[name="${o}"]`);c&&(c.type==="radio"||c.type==="checkbox"?c.value===i&&(c.checked=!0):c.value=i)})}}catch(r){console.error("Error loading draft from local storage:",r),localStorage.removeItem("orderDraft")}}const s={first_name:null,last_name:null,phone_number:null,address:null,province:null,city:null,postal_code:null};function U(){s.first_name=document.getElementById("first_name"),s.last_name=document.getElementById("last_name"),s.phone_number=document.getElementById("phone_number"),s.address=document.getElementById("address"),s.province=document.getElementById("province"),s.city=document.getElementById("city"),s.postal_code=document.getElementById("postal_code")}function L(e){s.first_name&&(s.first_name.value=e.first_name||""),s.last_name&&(s.last_name.value=e.last_name||""),s.phone_number&&(s.phone_number.value=e.phone_number||""),s.address&&(s.address.value=e.address||""),s.province&&(s.province.value=e.province||""),s.city&&(s.city.value=e.city||""),s.postal_code&&(s.postal_code.value=e.postal_code||""),Object.keys(s).forEach(r=>{const t=s[r];t&&C(t)})}function M(){s.first_name&&(s.first_name.value=""),s.last_name&&(s.last_name.value=""),s.phone_number&&(s.phone_number.value=""),s.address&&(s.address.value=""),s.province&&(s.province.value=""),s.city&&(s.city.value=""),s.postal_code&&(s.postal_code.value=""),Object.keys(s).forEach(e=>{const r=s[e];r&&C(r)})}function w(e){return new Intl.NumberFormat("fa-IR").format(e)}function S(){const e=document.getElementById("cart-items-summary"),r=document.getElementById("cart-total-price");if(!e||!r){console.warn("Cart summary elements not found for updateCartTotal.");return}let t=0;document.querySelectorAll("#cart-items-summary > div").forEach(o=>{const i=parseFloat(o.querySelector(".item-subtotal").dataset.subtotal);t+=i}),r.textContent=`${w(t)} تومان`,r.dataset.totalPrice=t}function O(e){const r=document.getElementById("place-order-form"),t=document.getElementById("place-order-btn");t&&(e?(t.innerHTML='<i class="fas fa-spinner fa-spin ml-2"></i> در حال ثبت سفارش...',t.disabled=!0,t.classList.add("opacity-70","cursor-not-allowed")):(t.innerHTML="ثبت سفارش نهایی",t.disabled=!1,t.classList.remove("opacity-70","cursor-not-allowed"))),r&&r.querySelectorAll("input, select, textarea, button:not(#place-order-btn)").forEach(i=>{i!==t&&(i.disabled=e)})}function V(){console.log("Checkout module initializing...");const e=document.getElementById("place-order-form"),r=document.getElementById("place-order-btn");document.getElementById("progress-bar"),document.getElementById("form-errors-live-region");const t=document.getElementById("cart-items-summary"),o=document.getElementById("cart-total-price"),i=e?JSON.parse(e.dataset.addresses||"[]"):[],c=e?JSON.parse(e.dataset.defaultAddress||"null"):null;e&&e.addEventListener("input",D(n=>{const a=n.target,u=a.id,f=a.value.trim();v[u]&&k(u,f,v[u],a)},500));const d=document.getElementById("address-selection-radios");if(d&&d.addEventListener("change",function(n){if(n.target.name==="selected_address_id"){const a=n.target.value;if(a==="new")M();else{const u=i.find(f=>f.id==a);u&&L(u)}}}),U(),c){L(c);const n=document.getElementById(`address_${c.id}`);n&&(n.checked=!0)}else{const n=document.getElementById("address_new");n&&(n.checked=!0),M()}J(),setInterval(P,3e4),window.addEventListener("beforeunload",function(n){localStorage.getItem("orderDraft")&&(n.preventDefault(),n.returnValue="تغییرات شما ذخیره نشده است. مطمئن هستید که می‌خواهید صفحه را ترک کنید؟")});const l=30*60*1e3;let m=null;function _(){m&&clearTimeout(m),m=setTimeout(()=>{window.showMessage("جلسه شما منقضی شده است. لطفاً صفحه را بازخوانی کنید تا اطلاعات به روز شوند.","warning",7e3),e&&e.classList.add("pointer-events-none","opacity-70"),r&&(r.disabled=!0)},l)}_(),e&&(e.addEventListener("input",_),e.addEventListener("change",_),e.addEventListener("submit",async function(n){if(n.preventDefault(),!navigator.onLine){window.showMessage("اتصال اینترنت برقرار نیست. لطفاً اتصال خود را بررسی کنید و دوباره تلاش کنید.","error");return}const a=new FormData(e),u=Object.fromEntries(a.entries());if(!x()){q(0,1);return}O(!0),q(0,4);try{const f=await N(u);window.showMessage(f.message,"success"),localStorage.removeItem("orderDraft"),f.orderId?(m&&clearTimeout(m),setTimeout(()=>{window.location.href=`/order/confirmation/${f.orderId}`},1500)):console.warn("Order ID not returned from server. Cart might need manual clearing.")}catch(f){console.error("Final order placement attempt failed:",f)}finally{O(!1),q(0,1)}})),t&&o&&S(),t&&t.addEventListener("click",async function(n){const a=n.target;if(a.classList.contains("quantity-btn")){const u=a.closest("[data-item-id]");if(!u)return;const f=u.dataset.itemId,I=parseFloat(u.dataset.itemPrice),h=u.querySelector(".item-quantity");let p=parseInt(h.dataset.quantity);const E=u.querySelector(".item-subtotal");let g=p;if(a.classList.contains("plus-btn"))p++;else if(a.classList.contains("minus-btn"))if(p>1)p--;else return;h.textContent=w(p),h.dataset.quantity=p;const T=I*p;E.textContent=`${w(T)} تومان`,E.dataset.subtotal=T,S();try{const B=await fetch(`/cart/update/${f}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":A()},body:JSON.stringify({quantity:p})}),F=await B.json();B.ok?window.showMessage(F.message||"تعداد محصول به‌روزرسانی شد.","success"):(window.showMessage(F.message||"خطا در به‌روزرسانی تعداد محصول.","error"),h.textContent=w(g),h.dataset.quantity=g,E.textContent=`${w(I*g)} تومان`,E.dataset.subtotal=I*g,S())}catch(B){console.error("Error updating cart item quantity:",B),window.showMessage("خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.","error"),h.textContent=w(g),h.dataset.quantity=g,E.textContent=`${w(I*g)} تومان`,E.dataset.subtotal=I*g,S()}}}),console.log("Checkout module initialized successfully.")}export{V as initCheckout};
//# sourceMappingURL=payment-system-BGXqsU2m.js.map
