import{a as z}from"./vendor-axios-xsH4HHeE.js";import{u as F}from"./ui-components-uVfRm-cR.js";const p=z.create({baseURL:"/"}),D=localStorage.getItem("jwt_token");D&&(p.defaults.headers.common.Authorization=`Bearer ${D}`);p.interceptors.request.use(s=>{const e=localStorage.getItem("jwt_token");return console.log("DEBUG: Axios Interceptor - Checking for JWT Token. Token found:",e?"Yes":"No"),e&&console.log("DEBUG: Axios Interceptor - Setting Authorization header with token:",e.substring(0,30)+"..."),e?s.headers.Authorization=`Bearer ${e}`:delete s.headers.Authorization,s},s=>Promise.reject(s));console.log("jwt_manager.js loaded and starting...");const H=s=>{localStorage.setItem("jwt_token",s),console.log("JWT Manager: Token stored.")},R=()=>localStorage.getItem("jwt_token"),S=()=>{localStorage.removeItem("jwt_token"),console.log("JWT Manager: Token cleared.")},K=Object.freeze(Object.defineProperty({__proto__:null,clearJwtToken:S,getJwtToken:R,storeJwtToken:H},Symbol.toStringTag,{value:"Module"}));console.log("api.js loaded and starting...");let P=null;const J=s=>{delete p.defaults.headers.common["X-Guest-UUID"],console.log("API: X-Guest-UUID header removed globally.")},G=async(s,e=!1)=>{var o;try{const t={mobile_number:s};e&&(t.is_registration=!0);const n=await p.post("/api/auth/send-otp",t);return console.log("API: OTP sent successfully:",n.data),n.data}catch(t){throw console.error("API: Error sending OTP:",((o=t.response)==null?void 0:o.data)||t.message),t}},W=async(s,e,o="")=>{var t;try{const n=await p.post("/api/auth/register",{mobile_number:s,name:e,lastname:o});return console.log("API: User registered and OTP sent successfully:",n.data),n.data}catch(n){throw console.error("API: Error during registration and OTP send:",((t=n.response)==null?void 0:t.data)||n.message),n}},U=async s=>{var e;try{const o=await p.post("/api/auth/register/request-otp",{mobile_number:s});return console.log("API: OTP requested for registration successfully:",o.data),o.data}catch(o){throw console.error("API: Error requesting OTP for registration:",((e=o.response)==null?void 0:e.data)||o.message),o}},X=async(s,e)=>{var o;try{const t=await p.post("/api/auth/verify-otp",{mobile_number:s,otp:e});return console.log("API: OTP verified and login successful:",t.data),t.data.access_token&&(H(t.data.access_token),localStorage.removeItem("guest_uuid"),J(null)),t.data}catch(t){throw console.error("API: Error verifying OTP and logging in:",((o=t.response)==null?void 0:o.data)||t.message),t}},ee=async()=>{var s;try{await p.post("/api/auth/logout",{},{headers:{Authorization:"Bearer "+localStorage.getItem("jwt_token")}}),S(),console.log("API: User logged out successfully."),window.location.href="/"}catch(e){throw console.error("API: Error logging out:",((s=e.response)==null?void 0:s.data)||e.message),e}},te=async()=>P?(console.warn("API: fetchCartContents request already in progress. Returning existing promise."),P):(P=new Promise(async(s,e)=>{var o,t,n;try{console.log("API: Initiating new fetchCartContents request.");const r=await p.get("/api/cart/contents");console.log("API: fetchCartContents response received:",r.data),s(r.data)}catch(r){console.error("API: Error fetching cart contents:",((o=r.response)==null?void 0:o.data)||r.message),e({success:!1,message:((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||"خطا در دریافت محتویات سبد خرید."})}finally{P=null}}),P),se=async(s,e=1,o=null)=>{var t,n,r;try{console.log(`API: Adding product ${s} to cart with quantity ${e}.`);const h=await p.post(`/api/cart/add/${s}`,{quantity:e,product_variant_id:o});return console.log("API: Product added to cart:",h.data),{success:!0,message:h.data.message||"محصول با موفقیت به سبد خرید اضافه شد.",data:h.data}}catch(h){throw console.error("API: Error adding to cart:",((t=h.response)==null?void 0:t.data)||h.message),{success:!1,message:((r=(n=h.response)==null?void 0:n.data)==null?void 0:r.message)||"خطا در افزودن محصول به سبد خرید."}}},oe=async(s,e)=>{var o,t,n;try{console.log(`API: Updating cart item ${s} quantity to ${e}.`);const r=await p.put(`/api/cart/update/${s}`,{quantity:e});return console.log("API: Cart item quantity updated:",r.data),{success:!0,message:r.data.message||"تعداد محصول در سبد خرید به‌روز شد.",data:r.data}}catch(r){throw console.error("API: Error updating cart item quantity:",((o=r.response)==null?void 0:o.data)||r.message),{success:!1,message:((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||"خطا در به‌روزرسانی تعداد محصول در سبد خرید."}}},ne=async s=>{var e,o,t;try{console.log(`API: Removing cart item ${s}.`);const n=await p.delete(`/api/cart/remove/${s}`);return console.log("API: Cart item removed:",n.data),{success:!0,message:n.data.message||"محصول از سبد خرید حذف شد.",data:n.data}}catch(n){throw console.error("API: Error removing cart item:",((e=n.response)==null?void 0:e.data)||n.message),{success:!1,message:((t=(o=n.response)==null?void 0:o.data)==null?void 0:t.message)||"خطا در حذف محصول از سبد خرید."}}},re=async()=>{var s,e,o;try{console.log("API: Clearing cart.");const t=await p.post("/api/cart/clear",{});return console.log("API: Cart cleared:",t.data),{success:!0,message:t.data.message||"سبد خرید با موفقیت پاک شد.",data:t.data}}catch(t){throw console.error("API: Error clearing cart:",((s=t.response)==null?void 0:s.data)||t.message),{success:!1,message:((o=(e=t.response)==null?void 0:e.data)==null?void 0:o.message)||"خطا در پاک کردن سبد خرید."}}},ae=async()=>{var s;try{const e=await p.get("/api/user");return console.log("API: User data fetched:",e.data),e.data}catch(e){throw console.error("API: Error fetching user data:",((s=e.response)==null?void 0:s.data)||e.message),S(),e}};console.log("auth.js loaded and starting...");const k=s=>{const e={"۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};let o="";for(let t=0;t<s.length;t++){const n=s[t];o+=e[n]||n}return o.replace(/\D/g,"")};class q{constructor(e,o,t){this.element=e,this.seconds=o,this.onCompleteCallback=t,this.interval=null}start(){this.stop(),this.updateDisplay(),this.interval=setInterval(()=>{var e;this.seconds--,this.updateDisplay(),this.seconds<=0&&(this.stop(),(e=this.onCompleteCallback)==null||e.call(this))},1e3)}stop(){clearInterval(this.interval),this.interval=null}reset(e){this.stop(),this.seconds=e,this.updateDisplay()}updateDisplay(){const e=Math.floor(this.seconds/60),o=this.seconds%60;this.element.textContent=`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}}const j=()=>{const s=document.querySelectorAll(".otp-digit-input");s.forEach(e=>{e.value=""}),s.length>0&&s[0].focus()},Z=()=>{const s=document.querySelectorAll(".otp-digit-input");let e="";return s.forEach(o=>{e+=o.value}),e};function Q(){console.log("Auth module initializing...");const s=document.getElementById("name"),e=document.getElementById("lastname"),o=document.getElementById("mobile_number"),t=document.getElementById("register-button");if(s&&o&&t){console.log("Auth.js: Register elements found. Initializing register logic.");const L=t.innerHTML;o.addEventListener("input",function(i){i.target.value=k(i.target.value)}),s&&s.addEventListener("input",function(i){i.target.value=i.target.value.replace(/[^a-zA-Z\u0600-\u06FF\s]/g,"")}),e&&e.addEventListener("input",function(i){i.target.value=i.target.value.replace(/[^a-zA-Z\u0600-\u06FF\s]/g,"")}),t.addEventListener("click",async function(){var c,A;const i=s.value,v=e?e.value:"",y=o.value;if(!i||i.trim()===""){window.showMessage("لطفاً نام خود را وارد کنید.","error");return}if(!y||!/^09\d{9}$/.test(y)){window.showMessage("لطفاً یک شماره موبایل معتبر وارد کنید (مثال: 09123456789).","error");return}t.disabled=!0,t.classList.add("opacity-50","cursor-not-allowed"),t.innerHTML='<i class="fas fa-spinner fa-spin ml-2"></i> در حال ثبت‌نام...',console.log("Auth.js: Register button clicked!");try{const l=await W(y,i,v);window.showMessage(l.message||"ثبت‌نام با موفقیت انجام شد. کد تأیید ارسال شد.","success"),window.location.href=`${window.location.origin}/auth/verify-otp-form?mobile_number=${y}`}catch(l){const g=((A=(c=l.response)==null?void 0:c.data)==null?void 0:A.message)||"خطا در ثبت‌نام. لطفاً دوباره تلاش کنید.";window.showMessage(g,"error"),console.error("Auth.js: Error during registration:",l)}finally{t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed"),t.innerHTML=L}})}else console.log("Auth.js: Register elements NOT found. Skipping register logic."),console.log("Auth.js: registerNameInput:",s),console.log("Auth.js: registerMobileNumberInput:",o),console.log("Auth.js: registerButton:",t);const n=document.getElementById("mobile_number"),r=document.getElementById("send-otp-button");if(n&&r){console.log("Auth.js: Login elements found. Initializing login logic.");const L=r.innerHTML;n.addEventListener("input",function(i){i.target.value=k(i.target.value)}),r.addEventListener("click",async function(){var v,y;const i=n.value;if(!i||!/^09\d{9}$/.test(i)){window.showMessage("لطفاً یک شماره موبایل معتبر وارد کنید (مثال: 09123456789).","error");return}r.disabled=!0,r.classList.add("opacity-50","cursor-not-allowed"),r.innerHTML='<i class="fas fa-spinner fa-spin ml-2"></i> در حال ارسال...';try{const c=await G(i);window.showMessage(c.message||"کد تأیید با موفقیت ارسال شد.","success"),c.user_exists===!1?(console.log("Auth.js: User does not exist, redirecting to registration form."),window.location.href=`${window.location.origin}/auth/register?mobile_number=${i}`):(console.log("Auth.js: User exists, redirecting to OTP verification form."),window.location.href=`${window.location.origin}/auth/verify-otp-form?mobile_number=${i}`)}catch(c){if(c.response&&c.response.status===404&&c.response.data.requires_registration)window.showMessage("ارسال کد تأیید ناموفق بود: این شماره در سیستم ما ثبت نشده است.","error"),console.log("Auth.js: Server indicated registration required. Not redirecting as per user request.");else{const A=((y=(v=c.response)==null?void 0:v.data)==null?void 0:y.message)||"خطا در ارسال کد تأیید. لطفاً دوباره تلاش کنید.";window.showMessage(A,"error"),console.error("Auth.js: Error sending OTP:",c)}}finally{r.disabled=!1,r.classList.remove("opacity-50","cursor-not-allowed"),r.innerHTML=L}})}else console.log("Auth.js: Login elements NOT found. Skipping login logic."),console.log("Auth.js: loginMobileNumberInput:",n),console.log("Auth.js: sendOtpButton:",r);const h=document.getElementById("countdown-timer"),a=document.getElementById("resend-otp-button"),T=a?a.querySelector("#resend-timer"):null,f=document.querySelectorAll(".otp-digit-input"),O=document.getElementById("hidden-mobile-number"),N=document.getElementById("current-mobile-number"),x=document.getElementById("change-mobile-button"),_=document.getElementById("change-mobile-modal"),$=document.getElementById("close-modal-button"),M=document.getElementById("new_mobile_number"),w=document.getElementById("send-new-otp-button"),b=document.getElementById("modal-error-message");let B,C;if(h&&a&&f.length>0&&O){let v=function(){B.reset(120),B.start(),a.disabled=!0,a.classList.add("opacity-50","cursor-not-allowed"),a.setAttribute("aria-disabled","true"),T&&(T.textContent="02:00")},y=function(){C.reset(120),C.start(),a.disabled=!0,a.classList.add("opacity-50","cursor-not-allowed"),a.setAttribute("aria-disabled","true")};console.log("Auth.js: OTP verification elements found. Initializing OTP logic.");const L=a.innerHTML,i=w?w.innerHTML:"";f.forEach((l,g)=>{l.addEventListener("input",function(d){d.target.value=k(d.target.value),d.target.value.length===1&&g<f.length-1&&f[g+1].focus()}),l.addEventListener("keydown",function(d){d.key==="Backspace"&&d.target.value===""&&g>0&&f[g-1].focus()}),l.addEventListener("paste",function(d){d.preventDefault();const m=d.clipboardData.getData("text"),u=k(m);for(let E=0;E<f.length;E++)E<u.length?f[E].value=u[E]:f[E].value="";const I=Math.min(u.length-1,f.length-1);I>=0&&f[I].focus()})}),M&&M.addEventListener("input",function(l){l.target.value=k(l.target.value)}),B=new q(h,120,()=>{a.disabled=!1,a.classList.remove("opacity-50","cursor-not-allowed"),a.removeAttribute("aria-disabled"),T&&(T.textContent=""),a.innerHTML=L}),C=new q(T,120,()=>{a.disabled=!1,a.classList.remove("opacity-50","cursor-not-allowed"),a.removeAttribute("aria-disabled"),T&&(T.textContent=""),a.innerHTML=L});const c=document.getElementById("verify-otp-ajax-button");c?(console.log('Auth.js: "ثبت و ورود" button (verify-otp-ajax-button) found!'),c.addEventListener("click",async function(){var d,m;console.log('Auth.js: "ثبت و ورود" button clicked!');const l=O.value,g=Z();console.log("Auth.js: Mobile Number for verification:",l),console.log("Auth.js: Combined OTP:",g),c.disabled=!0,c.classList.add("opacity-50","cursor-not-allowed"),c.innerHTML='<i class="fas fa-spinner fa-spin ml-2"></i> در حال بررسی...';try{const u=await X(l,g);if(window.showMessage(u.message||"ورود با موفقیت انجام شد.","success"),console.log("Auth.js: User data after login:",u.user),console.log("Auth.js: JWT Token:",u.access_token),u.access_token){localStorage.setItem("jwt_token",u.access_token);try{const I=await window.axios.post("/api/auth/jwt-login",{token:u.access_token});console.log("Auth.js: Web session login successful:",I.data)}catch(I){console.error("Auth.js: Error during web session login (jwt-login API call):",I),window.showMessage("خطا در ورود به سشن وب. لطفاً دوباره تلاش کنید.","error")}}F(),window.location.href="/"}catch(u){const I=((m=(d=u.response)==null?void 0:d.data)==null?void 0:m.message)||"خطا در ورود. لطفاً دوباره تلاش کنید.";window.showMessage(I,"error"),console.error("Auth.js: Error during OTP verification and login:",u),j()}finally{c.disabled=!1,c.classList.remove("opacity-50","cursor-not-allowed"),c.innerHTML='ثبت و ورود <i class="fas fa-sign-in-alt mr-2"></i>'}})):console.log('Auth.js: "ثبت و ورود" button (verify-otp-ajax-button) NOT found!'),a&&a.addEventListener("click",async function(){var g,d;const l=this.dataset.mobileNumber;if(!l){window.showMessage("شماره موبایل یافت نشد.","error");return}a.disabled=!0,a.classList.add("opacity-50","cursor-not-allowed"),a.innerHTML='<i class="fas fa-spinner fa-spin ml-2"></i> در حال ارسال...';try{const m=await U(l);window.showMessage(m.message||"کد تأیید مجدداً ارسال شد.","success"),j(),v(),y()}catch(m){const u=((d=(g=m.response)==null?void 0:g.data)==null?void 0:d.message)||"خطا در ارسال مجدد کد.";window.showMessage(u,"error"),console.error("Auth.js: Error resending OTP:",m),j()}finally{a.disabled=!1,a.classList.remove("opacity-50","cursor-not-allowed"),a.innerHTML=L}}),x&&_&&$&&M&&w&&(x.addEventListener("click",function(){_.classList.add("active"),b.classList.add("hidden"),b.classList.remove("animate-pulse"),M.value="",j()}),$.addEventListener("click",function(){_.classList.remove("active")}),w.addEventListener("click",async function(){var g,d;const l=M.value;if(!l||!/^09\d{9}$/.test(l)){b.textContent="لطفاً یک شماره موبایل معتبر وارد کنید (مثال: 09123456789).",b.classList.remove("hidden"),b.classList.add("animate-pulse"),setTimeout(()=>b.classList.remove("animate-pulse"),2e3);return}w.disabled=!0,w.classList.add("opacity-50","cursor-not-allowed"),w.innerHTML='<i class="fas fa-spinner fa-spin ml-2"></i> در حال ارسال...';try{const m=await U(l);window.showMessage(m.message||"شماره موبایل با موفقیت تغییر یافت. کد جدید ارسال شد.","success"),O.value=l,N&&(N.textContent=l),_.classList.remove("active"),j(),v(),y()}catch(m){const u=((d=(g=m.response)==null?void 0:g.data)==null?void 0:d.message)||"خطا در تغییر شماره موبایل.";b.textContent=u,b.classList.remove("hidden"),b.classList.add("animate-pulse"),setTimeout(()=>b.classList.remove("animate-pulse"),2e3),console.error("Auth.js: Error changing mobile number:",m),j()}finally{w.disabled=!1,w.classList.remove("opacity-50","cursor-not-allowed"),w.innerHTML=i}})),v();const A=document.querySelector(".error-container");A&&!A.classList.contains("hidden")&&j()}else console.log("Auth.js: OTP verification elements NOT found. Skipping OTP logic."),console.log("Auth.js: countdownTimerElement:",h),console.log("Auth.js: resendButton:",a),console.log("Auth.js: otpDigitInputs.length:",f.length),console.log("Auth.js: hiddenMobileNumberInput:",O)}const ie=Object.freeze(Object.defineProperty({__proto__:null,initAuth:Q},Symbol.toStringTag,{value:"Module"}));export{p as a,te as b,S as c,se as d,re as e,ae as f,R as g,ie as h,K as j,ee as l,ne as r,oe as u};
//# sourceMappingURL=auth-modules-Tx9inXK_.js.map
